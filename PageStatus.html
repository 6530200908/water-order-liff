<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="Styles.css">
</head>
<body>
  <div id="loader" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000;">
    <div class="spinner-border text-info"></div>
  </div>

  <div id="page-status" class="container mt-3">
    <h3 class="fw-bold mb-4 text-info">üì¶ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
    
    <div class="order-card shadow-sm">
        <div class="small text-muted mb-1">ORDER ID</div>
        <div id="o-id" class="h4 fw-bold text-info">---</div>
        <div class="small text-muted mt-3 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        <div id="o-items" class="fw-bold">---</div>
    </div>

    <div id="timeline-box"></div> 
  </div>

  <script src="Config.js"></script>
  <script>
    async function init() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID_STATUS });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
        const res = await fetch(`${CONFIG.GAS_API}?type=status&uid=${profile.userId}`).then(r => r.json());
        
        if(!res.order) { 
          document.getElementById("page-status").innerHTML = "<p class='text-center mt-5 text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>"; 
          return; 
        }

        document.getElementById("o-id").innerText = res.order.id;
        document.getElementById("o-items").innerText = res.order.items;
        
        const box = document.getElementById("timeline-box");
        box.innerHTML = ""; 

        // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó Status
        const steps = res.statusMaster; 
        // ‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)
        const activeIdx = steps.findIndex(s => s.desc.trim() === res.order.status.trim());
        
        steps.forEach((s, i) => {
          const div = document.createElement("div");
          
          let statusClass = "";
          if (i < activeIdx) statusClass = "done";
          else if (i === activeIdx) statusClass = "active";

          div.className = `t-item ${statusClass}`;
          div.innerHTML = `
            <div class="t-icon"></div>
            <div class="t-text">${s.desc}</div>
          `;
          box.appendChild(div);
        });

      } catch (e) { 
        console.error(e);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      } finally { 
        document.getElementById("loader").style.display = "none"; 
      }
    }
    window.onload = init;
  </script>
</body>
</html>
