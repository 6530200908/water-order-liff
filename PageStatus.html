<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="Styles.css">
</head>
<body>
  <div id="loader"><div class="spinner-border text-info"></div></div>
  <div id="page-status" class="container mt-3">
    <h3 class="fw-bold mb-4 text-info">üì¶ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>
    <div class="order-card p-3 mb-4 bg-dark rounded-4 shadow-sm">
        <div class="small text-muted mb-1">ORDER ID</div>
        <div id="o-id" class="h4 fw-bold text-info">---</div>
        <div class="small text-muted mt-3 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        <div id="o-items" class="fw-bold">---</div>
    </div>
    <div id="timeline-box" class="mt-4"></div> 
  </div>

  <script src="Config.js"></script>
  <script>
  async function init() {
    try {
      await liff.init({ liffId: CONFIG.LIFF_ID_STATUS });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      const res = await fetch(`${CONFIG.GAS_API}?type=status&uid=${profile.userId}`).then(r => r.json());
      
      if(!res.order) { 
        document.getElementById("page-status").innerHTML = "<div class='text-center mt-5 text-muted'>üöö ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>"; 
        return; 
      }
      
      document.getElementById("o-id").innerText = res.order.id;
      document.getElementById("o-items").innerText = res.order.items;
      
      const box = document.getElementById("timeline-box");
      box.innerHTML = ""; 
      
      // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏Å (Master Status)
      const steps = res.statusMaster;
      // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
      const activeIdx = steps.findIndex(s => s.desc === res.order.status);
      
      steps.forEach((s, i) => {
        const item = document.createElement("div");
        // i < activeIdx = ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (done)
        // i === activeIdx = ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà (active)
        let statusClass = "";
        if (i < activeIdx) statusClass = "done";
        else if (i === activeIdx) statusClass = "active";

        item.className = `timeline-item ${statusClass}`;
        item.innerHTML = `
          <div class="timeline-dot"></div>
          <div class="timeline-content">
            <div class="status-name">${s.desc}</div>
            ${i === activeIdx ? `<div class="status-time">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${res.order.time}</div>` : ""}
          </div>
        `;
        box.appendChild(item);
      });
    } catch (e) { 
      console.error(e); 
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
    } finally { 
      document.getElementById("loader").style.display = "none"; 
    }
  }
  window.onload = init;
</script>
</body>
</html>
