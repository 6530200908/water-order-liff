<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --bg: #1a1d21; --card: #2c3036; --blue: #0dcaf0; --dim: #555; --red: #ff4d4d; }
    body { background: var(--bg); color: white; padding: 20px; font-family: sans-serif; }
    .status-card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    
    .timeline { position: relative; list-style: none; padding: 0; margin: 20px 0; }
    .t-item { position: relative; padding-left: 45px; margin-bottom: 35px; color: var(--dim); }
    .t-item::before { content: ""; position: absolute; left: 7px; top: 0; bottom: -35px; width: 2px; background: var(--dim); }
    .t-item:last-child::before { display: none; }
    .t-icon { position: absolute; left: 0; top: 4px; width: 16px; height: 16px; border-radius: 50%; background: var(--dim); border: 2px solid var(--bg); z-index: 2; }
    
    .active { color: var(--blue); font-weight: bold; }
    .active .t-icon { background: var(--blue); box-shadow: 0 0 12px var(--blue); transform: scale(1.3); }
    .done { color: #ccc; }
    .done .t-icon, .done::before { background: var(--blue); }
    
    .alert-error { background: rgba(255, 77, 77, 0.15); border: 1px solid var(--red); color: var(--red); border-radius: 12px; padding: 15px; margin-top: 15px; display: none; animation: shake 0.5s; }
    @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
  </style>
</head>
<body>

  <div id="loader" class="text-center mt-5"><div class="spinner-border text-info"></div></div>

  <div id="content" style="display:none;">
    <h4 class="mb-4 fw-bold">üì¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h4>
    <div class="status-card">
      <div id="timeline-box" class="timeline"></div>
      
      <div id="error-box" class="alert-error">
        <strong>‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> <span id="error-msg"></span>
      </div>

      <hr style="border-color: #444;">
      <div class="small text-secondary mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <span id="o-id" class="text-white"></span></div>
      <div class="small text-secondary mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <span id="o-items" class="text-white"></span></div>
      <div class="small text-secondary">‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: <span id="o-time" class="text-white"></span></div>
    </div>
    <a href="index.html" class="btn btn-outline-info w-100 p-3 mt-4 rounded-pill fw-bold">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</a>
  </div>

<script>
const GAS_API = "https://script.google.com/macros/s/AKfycbyes1oLr5TUnK1EG-FEdfUVCAN-zWnAwtu7absTVnOaBbPWwNN8mTRnskaUOCFBEgtjpg/exec"; // ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

async function init() {
  await liff.init({ liffId: "2008821220-URtBKHjL" });
  if (!liff.isLoggedIn()) { liff.login(); return; }
  const profile = await liff.getProfile();

  fetch(`${GAS_API}?type=status&uid=${profile.userId}`)
    .then(res => res.json())
    .then(res => {
      document.getElementById("loader").style.display = "none";
      if (!res.order) { document.body.innerHTML = '<div class="text-center mt-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>'; return; }
      document.getElementById("content").style.display = "block";

      const box = document.getElementById("timeline-box");
      const currentStatusObj = res.statusMaster.find(s => s.desc === res.order.status);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      const isDecimal = currentStatusObj ? currentStatusObj.id.includes('.') : false;
      const mainSteps = res.statusMaster.filter(s => !s.id.includes('.'));
      
      let activeIdx = -1;
      if (!isDecimal) {
        activeIdx = mainSteps.findIndex(s => s.desc === res.order.status);
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° ‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤" ‡πÄ‡∏õ‡πá‡∏ô Active
        const currentId = parseFloat(currentStatusObj.id);
        activeIdx = mainSteps.findLastIndex(s => parseFloat(s.id) < currentId);
        
        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ö‡πÅ‡∏î‡∏á
        document.getElementById("error-box").style.display = "block";
        document.getElementById("error-msg").innerText = res.order.status;
      }

      mainSteps.forEach((s, i) => {
        const item = document.createElement("div");
        item.className = "t-item " + (i < activeIdx ? "done" : (i === activeIdx ? "active" : ""));
        item.innerHTML = `<div class="t-icon"></div>${s.desc}`;
        box.appendChild(item);
      });

      document.getElementById("o-id").innerText = res.order.id;
      document.getElementById("o-items").innerText = res.order.items;
      document.getElementById("o-time").innerText = res.order.time;
    });
}
window.onload = init;
</script>
</body>
</html>
