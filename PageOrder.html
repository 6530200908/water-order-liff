<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏° - ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="Styles.css">
  <style>
    #map { 
      height: 250px; 
      width: 100%; 
      border-radius: 12px; 
      margin-bottom: 10px; 
      border: 2px solid #0dcaf0;
    }
    .modal-card { max-height: 90vh; overflow-y: auto; }
  </style>
</head>
<body>
  <div id="loader"><div class="spinner-border text-info"></div></div>
  
  <div id="page-order" class="container" style="padding-bottom: 120px;">
    <div class="d-flex justify-content-between align-items-center my-4">
      <h4 class="fw-bold m-0 text-info">üõí ‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°</h4>
      <button onclick="window.location.href='PageStatus.html'" class="btn btn-sm btn-outline-info rounded-pill">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
    </div>
    <div id="product-list"></div>
    <div class="sticky-footer">
      <div class="d-flex justify-content-between mb-2 fs-5">
        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
        <span class="fw-bold text-info"><span id="total-price">0</span> ‡∏ø</span>
      </div>
      <button class="btn btn-info w-100 p-3 fw-bold rounded-3" onclick="openPayment()">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
    </div>
  </div>

  <div id="payment-ui" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; padding:20px;">
    <div class="modal-card bg-white p-4 rounded-4 shadow-lg mx-auto" style="max-width:500px;">
      <h5 class="text-center fw-bold mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h5>
      <label class="small text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
      <input type="text" id="cusName" class="form-control mb-3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö">
      
      <label class="small text-muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</label>
      <select id="locSelect" class="form-select mb-3" onchange="handleLocationChange(this.value)"></select>
      
      <div id="gps-section" style="display:none;">
        <label class="small text-muted mb-2 text-primary">üìç ‡∏à‡∏¥‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á‡∏ô‡πâ‡∏≥</label>
        <div id="map"></div>
        <p id="gpsStatus" class="small text-center mb-2 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</p>
        <input type="hidden" id="gpsData">
        <textarea id="cusAddress" class="form-control mb-3" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏° ‡∏ä‡∏±‡πâ‡∏ô 1)"></textarea>
      </div>

      <button id="btn-confirm" class="btn btn-info w-100 p-3 fw-bold rounded-3" onclick="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
      <button class="btn btn-link w-100 text-muted" onclick="closePayment()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="Config.js"></script>
  <script>
    let currentUserId = "", products = [], cart = {}, map, marker;

    async function init() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID_ORDER });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        currentUserId = profile.userId;

        const res = await fetch(`${CONFIG.GAS_API}?uid=${currentUserId}`).then(r => r.json());
        products = res.products;
        renderProducts();

        const select = document.getElementById("locSelect");
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>';
        res.locations.forEach(loc => select.innerHTML += `<option value="${loc}">${loc}</option>`);
        select.innerHTML += '<option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">üìç ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á)</option>';

        if (res.customer) {
          document.getElementById("cusName").value = res.customer.name || profile.displayName;
          const isStandardLoc = res.locations.includes(res.customer.address);
          if (res.customer.address && !isStandardLoc) {
            select.value = "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";
            handleLocationChange("‡∏≠‡∏∑‡πà‡∏ô‡πÜ");
            document.getElementById("cusAddress").value = res.customer.address;
            if (res.customer.gps) {
              document.getElementById("gpsData").value = res.customer.gps;
              document.getElementById("gpsStatus").innerText = "‚úÖ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ)";
              // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏° ‡∏à‡∏∞‡πÑ‡∏õ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô initMap
            }
          } else {
            select.value = res.customer.address || "";
          }
        } else {
          document.getElementById("cusName").value = profile.displayName;
        }
      } catch (e) { console.error(e); }
      finally { document.getElementById("loader").style.display = "none"; }
    }

    function handleLocationChange(v) {
      const section = document.getElementById("gps-section");
      if (v === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ") {
        section.style.display = "block";
        setTimeout(initMap, 300); // ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤ UI ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
      } else {
        section.style.display = "none";
      }
    }

    function initMap() {
      if (map) {
        map.invalidateSize();
        return;
      }
      
      // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏õ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û)
      let startLat = 13.7563, startLng = 100.5018;
      const oldGps = document.getElementById("gpsData").value;
      if (oldGps) {
        const parts = oldGps.split(',');
        startLat = parseFloat(parts[0]);
        startLng = parseFloat(parts[1]);
      }

      map = L.map('map').setView([startLat, startLng], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      if (oldGps) {
        marker = L.marker([startLat, startLng]).addTo(map);
      }

      map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        if (marker) marker.setLatLng(e.latlng);
        else marker = L.marker(e.latlng).addTo(map);
        
        document.getElementById("gpsData").value = `${lat},${lng}`;
        document.getElementById("gpsStatus").innerText = `üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        document.getElementById("gpsStatus").className = "small text-center mb-2 text-success fw-bold";
      });
    }

    function renderProducts() {
      document.getElementById("product-list").innerHTML = products.map((p, i) => `
        <div class="product-card d-flex justify-content-between align-items-center p-3 mb-2 bg-dark rounded-3 text-white">
          <div><div class="fw-bold">${p.desc}</div><div class="text-info small">${p.price} ‡∏ø</div></div>
          <div class="d-flex align-items-center gap-3">
            <button class="btn btn-sm btn-outline-light rounded-circle" onclick="updateQty(${i},-1)">-</button>
            <span id="qty-${i}" class="fw-bold">0</span>
            <button class="btn btn-sm btn-outline-info rounded-circle" onclick="updateQty(${i},1)">+</button>
          </div>
        </div>`).join("");
    }

    function updateQty(i, d) {
      cart[i] = Math.max(0, (cart[i] || 0) + d);
      document.getElementById(`qty-${i}`).innerText = cart[i];
      let total = 0;
      Object.keys(cart).forEach(k => { total += cart[k] * products[k].price; });
      document.getElementById("total-price").innerText = total;
    }

    function openPayment() { 
      if(document.getElementById("total-price").innerText === "0") return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); 
      document.getElementById("payment-ui").style.display = "block"; 
    }
    
    function closePayment() { document.getElementById("payment-ui").style.display = "none"; }

    function confirmOrder() {
      const loc = document.getElementById("locSelect").value;
      const gps = document.getElementById("gpsData").value;
      const extra = document.getElementById("cusAddress").value;
      const cusName = document.getElementById("cusName").value;

      if (!loc) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á");
      if (loc === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" && !gps) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

      const finalAddr = (loc === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ") ? extra : loc;
      const gpsValue = (loc === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ") ? gps : "";
      const totalPrice = document.getElementById("total-price").innerText;

      const itemsDetail = Object.keys(cart).filter(i => cart[i] > 0)
        .map(i => `- ${products[i].desc} x ${cart[i]}`).join("\n");

      const orderData = { 
        uid: currentUserId, name: cusName, address: finalAddr, gps: gpsValue,
        items: Object.keys(cart).filter(i => cart[i] > 0).map(i => products[i].desc).join(", "),
        amounts: Object.keys(cart).filter(i => cart[i] > 0).map(i => String(cart[i])).join(", "),
        total: totalPrice 
      };

      document.getElementById("btn-confirm").disabled = true;
      document.getElementById("btn-confirm").innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

      fetch(CONFIG.GAS_API, { method: "POST", body: JSON.stringify(orderData) })
        .then(r => r.json())
        .then(res => {
          const msg = `üíß ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${res.orderId}\n‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${cusName}\n‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: ${finalAddr}\n${gpsValue ? 'üìç ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß\n' : ''}‡∏£‡∏ß‡∏°: ${totalPrice} ‡∏ø`;
          liff.sendMessages([{ type: "text", text: msg }]).finally(() => liff.closeWindow());
        })
        .catch(() => {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
          document.getElementById("btn-confirm").disabled = false;
        });
    }

    window.onload = init;
  </script>
</body>
</html>
