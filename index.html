<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
  <div id="product-list">กำลังโหลด...</div>
  <hr>
  รวม: <span id="total">0</span> บาท  
  <br><br>
  <button onclick="submitOrder()">ยืนยัน</button>

<script>
const GAS_API = "https://script.google.com/macros/s/AKfycbzshx9Z-2r_Fo-G1gqDZSC7du8V0frLoMScjLD1GunF-X3hUeqR1EjXv64U30Ks1_QqfA/exec";
let products = [];
let cart = {};
let uid = "";

async function init() {
  await liff.init({ liffId: "2008859930-NxfsF3xM" });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  uid = profile.userId;

  loadProducts();
}

function loadProducts() {
  fetch(GAS_API)
    .then(r => r.json())
    .then(data => {
      products = data;
      document.getElementById("product-list").innerHTML =
        data.map((p,i) =>
          `<div>
            ${p.desc} (${p.price})
            <button onclick="add(${i})">+</button>
          </div>`
        ).join("");
    });
}

function add(i) {
  cart[i] = (cart[i] || 0) + 1;
  let total = 0;
  for (let k in cart) {
    total += cart[k] * products[k].price;
  }
  document.getElementById("total").innerText = total;
}

function submitOrder() {
  const order = {
    uid: uid,
    items: Object.keys(cart)
      .map(i => `${products[i].desc} x${cart[i]}`)
      .join(", "),
    total: document.getElementById("total").innerText
  };

  fetch(GAS_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(order)
  }).then(() => {
    liff.closeWindow();
  });
}

window.onload = init;
</script>
</body>
</html>
