<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#1a1d21; color:white; padding:10px; }
</style>
</head>

<body>
<h4>üõí ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°</h4>
<div id="product-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</div>
<hr>
‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ø  
<button class="btn btn-primary w-100 mt-2" onclick="showPayment()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>

<div id="payment" style="display:none; background:white; color:black; padding:15px;">
  <input id="name" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
  <textarea id="address" class="form-control mb-2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà"></textarea>
  <button class="btn btn-success w-100" onclick="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
</div>

<script>
const GAS_API = "üî• ‡πÉ‡∏™‡πà URL Web App üî•";
let products = [];
let cart = {};
let uid = "";

async function init() {
  await liff.init({ liffId: "2008859930-NxfsF3xM" });
  const profile = await liff.getProfile();
  uid = profile.userId;
  document.getElementById("name").value = profile.displayName;
  loadProducts();
}

function loadProducts() {
  fetch(GAS_API)
    .then(r => r.json())
    .then(d => {
      products = d;
      render();
    });
}

function render() {
  const el = document.getElementById("product-list");
  el.innerHTML = "";

  products.forEach((p, i) => {
    el.innerHTML += `
      <div class="d-flex justify-content-between mb-2">
        <span>${p.desc} (${p.price}‡∏ø)</span>
        <button class="btn btn-sm btn-light" onclick="add(${i})">+</button>
        <span id="q${i}">0</span>
      </div>
    `;
  });
}

function add(i) {
  cart[i] = (cart[i] || 0) + 1;
  document.getElementById(`q${i}`).innerText = cart[i];
  calc();
}

function calc() {
  let t = 0;
  Object.keys(cart).forEach(i => {
    t += cart[i] * products[i].price;
  });
  document.getElementById("total").innerText = t;
}

function showPayment() {
  document.getElementById("payment").style.display = "block";
}

function confirmOrder() {
  const order = {
    uid,
    name: document.getElementById("name").value,
    address: document.getElementById("address").value,
    items: Object.keys(cart).map(i => `${products[i].desc} x${cart[i]}`).join(", "),
    total: document.getElementById("total").innerText
  };

  fetch(GAS_API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(order)
  }).then(() => {
    liff.sendMessages([{ type:"text", text:"‚úÖ ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß" }])
      .finally(() => liff.closeWindow());
  });
}

window.onload = init;
</script>
</body>
</html>
