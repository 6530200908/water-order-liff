<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background-color: #1a1d21; color: white; padding: 10px; font-family: sans-serif; }
  #debug-box { background: #000; color: #0f0; padding: 10px; font-size: 11px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
  .product-item { background: #2c3036; border: 1px solid #3e444d; border-radius: 12px; padding: 12px; margin-bottom: 8px; }
  .checkout-form { display: none; background: white; color: #333; border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
</style>
</head>
<body>

<div id="debug-box">
  <b>üîç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö:</b><br>
  - LIFF: <span id="st-init">‡∏£‡∏≠...</span> | Login: <span id="st-login">‡∏£‡∏≠...</span><br>
  - UserID: <span id="st-uid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á...</span>
</div>

<div id="app-content">
  <h5 class="mb-3">üõí ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°</h5>
  <div id="product-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</div>
  <hr class="border-secondary">
  <div class="d-flex justify-content-between mb-3 fs-5">
    <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span> <span id="total-price" class="fw-bold text-info">0</span> ‡∏ø
  </div>
  <button id="btn-next" class="btn btn-primary w-100 p-3 fw-bold" disabled>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</button>
</div>

<div id="payment-ui" class="checkout-form">
  <h5 class="text-center mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h5>
  <div class="mb-3">
    <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
    <input type="text" id="cusName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
  </div>
  <div class="mb-3">
    <label class="form-label fw-bold">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
    <textarea id="cusAddress" class="form-control" rows="3" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô ‡∏ñ‡∏ô‡∏ô ‡∏ã‡∏≠‡∏¢..."></textarea>
  </div>
  <button id="btn-confirm" class="btn btn-success w-100 p-3 fw-bold" onclick="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <button class="btn btn-link w-100 mt-2 text-muted" onclick="location.reload()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
</div>

<script>
const GAS_API = "https://script.google.com/macros/s/AKfycbwajp6xbNQ5VsTeZ7GdLgqK3sUnLqlDsLL3YA-89ewgwkYZwMs8SPYHvtCyCKixDKKuPg/exec";
let products = [], cart = {}, currentUserId = "";

async function init() {
  try {
    await liff.init({ liffId: "2008821220-C8oqqBvB" });
    document.getElementById("st-init").innerText = "OK ‚úÖ";
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    document.getElementById("st-login").innerText = "Yes ‚úÖ";

    const profile = await liff.getProfile();
    currentUserId = profile.userId;
    document.getElementById("st-uid").innerText = currentUserId;
    document.getElementById("cusName").value = profile.displayName;

    const btnNext = document.getElementById("btn-next");
    btnNext.disabled = false;
    btnNext.innerText = "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô";
    btnNext.onclick = () => {
      if(document.getElementById("total-price").innerText == "0") return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
      document.getElementById("app-content").style.display = "none";
      document.getElementById("payment-ui").style.display = "block";
    };

    loadProducts();
  } catch (err) {
    document.getElementById("st-init").innerText = "Error ‚ùå";
    console.error(err);
  }
}

function loadProducts() {
  fetch(GAS_API)
    .then(res => res.json())
    .then(data => {
      products = data;
      renderProducts();
    })
    .catch(() => document.getElementById("product-list").innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
}

function renderProducts() {
  document.getElementById("product-list").innerHTML = products.map((p, i) => `
    <div class="product-item d-flex justify-content-between align-items-center">
      <div><b>${p.desc}</b><br><small class="text-info">${p.price} ‡∏ø</small></div>
      <div class="d-flex align-items-center gap-3">
        <button class="btn btn-sm btn-outline-light" onclick="updateQty(${i},-1)">-</button>
        <span id="qty-${i}" class="fw-bold">0</span>
        <button class="btn btn-sm btn-outline-light" onclick="updateQty(${i},1)">+</button>
      </div>
    </div>`).join("");
}

function updateQty(i, d) {
  cart[i] = Math.max(0, (cart[i] || 0) + d);
  document.getElementById(`qty-${i}`).innerText = cart[i];
  let total = 0;
  Object.keys(cart).forEach(k => total += cart[k] * products[k].price);
  document.getElementById("total-price").innerText = total;
}

function confirmOrder() {
  const btn = document.getElementById("btn-confirm");
  btn.disabled = true;
  btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  const order = {
    uid: currentUserId,
    name: document.getElementById("cusName").value,
    address: document.getElementById("cusAddress").value,
    items: Object.keys(cart).filter(i => cart[i] > 0).map(i => `${products[i].desc} x${cart[i]}`).join(", "),
    total: document.getElementById("total-price").innerText
  };

  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheets ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î CORS
  fetch(GAS_API, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(order)
  })
  .then(() => {
    liff.sendMessages([{
      type: "text",
      text: `‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${order.items}\n‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${order.total} ‡∏ö‡∏≤‡∏ó`
    }]).finally(() => liff.closeWindow());
  })
  .catch(err => {
    alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
    btn.disabled = false;
  });
}

window.onload = init;
</script>
</body>
</html>
