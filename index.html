<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --main-bg: #1a1d21; --card-bg: #2c3036; --accent: #0dcaf0; }
    body { background-color: var(--main-bg); color: white; padding: 15px; padding-bottom: 120px; font-family: sans-serif; }
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--main-bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .product-card { background: var(--card-bg); border: 1px solid #3e444d; border-radius: 16px; padding: 15px; margin-bottom: 12px; }
    #payment-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; padding: 20px; }
    .modal-card { background: white; color: #333; border-radius: 24px; padding: 25px; max-width: 500px; margin: auto; }
    .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--main-bg); padding: 20px; border-top: 1px solid #333; z-index: 100; }
    #cusAddress { display: none; }
    .btn-info { background-color: var(--accent); border: none; }
  </style>
</head>
<body>

  <div id="loader">
    <div class="spinner-border text-info"></div>
    <div class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold m-0 text-info">üõí ‡∏™‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°</h4>
    <a href="status.html" class="btn btn-sm btn-outline-info rounded-pill">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</a>
  </div>

  <div id="product-list"></div>

  <div class="sticky-footer">
    <div class="d-flex justify-content-between mb-2 fs-5">
      <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
      <span class="fw-bold text-info"><span id="total-price">0</span> ‡∏ø</span>
    </div>
    <button id="btn-next" class="btn btn-info w-100 p-3 fw-bold rounded-3" disabled onclick="openPayment()">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
  </div>

  <div id="payment-ui">
    <div class="modal-card shadow-lg">
      <h5 class="text-center fw-bold mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ô‡πâ‡∏≥</h5>
      <div class="mb-3">
        <label class="form-label small">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
        <input type="text" id="cusName" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠">
      </div>
      <div class="mb-3">
        <label class="form-label small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</label>
        <select id="locSelect" class="form-select" onchange="toggleOther(this.value)">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>
        </select>
      </div>
      <textarea id="cusAddress" class="form-control mb-4" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï)"></textarea>
      
      <button id="btn-confirm" class="btn btn-success w-100 p-3 fw-bold rounded-3 mb-2" onclick="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
      <button class="btn btn-link w-100 text-muted" onclick="closePayment()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </div>
  </div>

<script>
const GAS_API = "https://script.google.com/macros/s/AKfycbw-4Oz0k-XYZVypd9O7NxxYOJabu2ikch90-j2_aeUF8u6PToahfDn4nfuKK-ZiX5FyRQ/exec"; 
let products = [], cart = {}, currentUserId = "";

async function init() {
  await liff.init({ liffId: "2008821220-C8oqqBvB" });
  if (!liff.isLoggedIn()) { liff.login(); return; }
  const profile = await liff.getProfile();
  currentUserId = profile.userId;

  fetch(`${GAS_API}?uid=${currentUserId}`)
    .then(res => res.json())
    .then(res => {
      document.getElementById("loader").style.display = "none";
      products = res.products;
      renderProducts();
      
      const select = document.getElementById("locSelect");
      res.locations.forEach(loc => {
        if(loc) select.innerHTML += `<option value="${loc}">${loc}</option>`;
      });

      if (res.customer) {
        document.getElementById("cusName").value = res.customer.name;
        if (res.locations.includes(res.customer.address)) {
          select.value = res.customer.address;
          toggleOther(res.customer.address);
        } else {
          select.value = "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";
          document.getElementById("cusAddress").style.display = "block";
          document.getElementById("cusAddress").value = res.customer.address;
        }
      } else {
        document.getElementById("cusName").value = profile.displayName;
      }
      document.getElementById("btn-next").disabled = false;
    });
}

function renderProducts() {
  const list = document.getElementById("product-list");
  list.innerHTML = products.map((p, i) => `
    <div class="product-card d-flex justify-content-between align-items-center">
      <div><div class="fw-bold">${p.desc}</div><div class="text-info small">${p.price} ‡∏ø / ‡πÅ‡∏û‡πá‡∏Ñ</div></div>
      <div class="d-flex align-items-center gap-3">
        <button class="btn btn-sm btn-outline-light rounded-circle" onclick="updateQty(${i},-1)" style="width:32px; height:32px;">-</button>
        <span id="qty-${i}" class="fw-bold fs-5">0</span>
        <button class="btn btn-sm btn-outline-info rounded-circle" onclick="updateQty(${i},1)" style="width:32px; height:32px;">+</button>
      </div>
    </div>`).join("");
}

function updateQty(i, d) {
  cart[i] = Math.max(0, (cart[i] || 0) + d);
  document.getElementById(`qty-${i}`).innerText = cart[i];
  let total = 0;
  Object.keys(cart).forEach(k => { total += cart[k] * products[k].price; });
  document.getElementById("total-price").innerText = total;
}

function toggleOther(val) {
  document.getElementById("cusAddress").style.display = (val === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ") ? "block" : "none";
}

function openPayment() {
  if(document.getElementById("total-price").innerText === "0") return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
  document.getElementById("payment-ui").style.display = "block";
}

function closePayment() {
  document.getElementById("payment-ui").style.display = "none";
}

function confirmOrder() {
  const loc = document.getElementById("locSelect").value;
  const finalAddr = (loc === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ") ? document.getElementById("cusAddress").value : loc;
  const cusName = document.getElementById("cusName").value;
  
  if(!finalAddr || !cusName) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á");

  const btn = document.getElementById("btn-confirm");
  btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  const itemsInCart = Object.keys(cart).filter(i => cart[i] > 0);
  const itemListText = itemsInCart.map(i => `- ${products[i].desc} x ${cart[i]}`).join("\n");
  const totalPrice = document.getElementById("total-price").innerText;

  const orderData = {
    uid: currentUserId,
    name: String(cusName),
    address: String(finalAddr),
    items: itemsInCart.map(i => products[i].desc).join(", "),
    amounts: itemsInCart.map(i => String(cart[i])).join(", "),
    total: String(totalPrice)
  };

  fetch(GAS_API, {
    method: "POST",
    body: JSON.stringify(orderData)
  })
  .then(res => res.json())
  .then(res => {
    if(res.status === "ok") {
      liff.sendMessages([{ 
        type: "text", 
        text: `‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${res.orderId}\n‡∏Ñ‡∏∏‡∏ì: ${orderData.name}\n‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á:\n${itemListText}\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${orderData.total} ‡∏ø\nüìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: ${orderData.address}`
      }]).finally(() => liff.closeWindow());
    }
  })
  .catch(e => {
    alert("‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠");
    btn.disabled = false;
    btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠";
  });
}

window.onload = init;
</script>
</body>
</html>
