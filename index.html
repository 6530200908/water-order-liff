<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background-color: #1a1d21; color: white; padding: 10px; }
    #debug-box { background: #000; color: #0f0; padding: 10px; font-size: 12px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #333; }
    .status-red { color: #ff4d4d; }
    .status-green { color: #00ff00; }
  </style>
</head>

<body>

<div id="debug-box">
  <b>üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b><br>
  - LIFF Init: <span id="st-init">‡∏£‡∏≠...</span><br>
  - Login Status: <span id="st-login">‡∏£‡∏≠...</span><br>
  - UserID: <span id="st-uid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
</div>

<div id="app-content">
  <div id="product-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</div>
  <hr>
  ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="total-price" class="fw-bold">0</span> ‡∏ø
  <button id="btn-next" class="btn btn-primary w-100 mt-2" disabled>‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LINE...</button>
</div>

<div id="payment-ui" style="display:none; background:white; color:black; padding:20px; border-radius:15px;">
  <h5>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h5>
  <input type="text" id="cusName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
  <textarea id="cusAddress" class="form-control mb-2" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà"></textarea>
  <button class="btn btn-success w-100" onclick="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>

<script>
  const GAS_API = "https://script.google.com/macros/s/AKfycbxpgFX47U1OrtHWwV0xFck-w-z1_c7iCL_9HrJmCl_bA1dAsDx17FN7fDuOccObkILxag/exec"; // üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  let products = [];
  let cart = {};
  let currentUserId = "";

  function logStatus(id, text, isError = false) {
    const el = document.getElementById(id);
    el.innerText = text;
    el.className = isError ? "status-red" : "status-green";
  }

  async function init() {
    try {
      await liff.init({ liffId: "2008859930-NxfsF3xM" });
      logStatus("st-init", "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    } catch (e) {
      logStatus("st-init", "Init error", true);
      return;
    }

    if (!liff.isInClient()) {
      logStatus("st-login", "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE App", true);
      return;
    }

    if (!liff.isLoggedIn()) {
      logStatus("st-login", "‡∏Å‡∏≥‡∏•‡∏±‡∏á Login...");
      liff.login();
      return;
    }

    logStatus("st-login", "Log-in ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");

    try {
      const profile = await liff.getProfile();
      currentUserId = profile.userId;
      document.getElementById("cusName").value = profile.displayName;
      logStatus("st-uid", currentUserId);

      document.getElementById("btn-next").disabled = false;
      document.getElementById("btn-next").innerText = "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô";
      document.getElementById("btn-next").onclick = showPayment;
    } catch {
      logStatus("st-uid", "‡∏î‡∏∂‡∏á UserID ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", true);
      return;
    }

    loadProducts();
  }

  function loadProducts() {
    fetch(GAS_API)
      .then(res => res.json())
      .then(data => {
        products = data;
        renderProducts();
      })
      .catch(err => {
        document.getElementById("product-list").innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        console.error(err);
      });
  }

  function renderProducts() {
    document.getElementById("product-list").innerHTML = products.map((p, i) => `
      <div class="d-flex justify-content-between align-items-center mb-2 p-2 border border-secondary rounded">
        <span>${p.desc} (${p.price}‡∏ø)</span>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-sm btn-light" onclick="updateQty(${i},1)">+</button>
          <span id="qty-${i}">0</span>
        </div>
      </div>
    `).join("");
  }

  function updateQty(i, d) {
    cart[i] = Math.max(0, (cart[i] || 0) + d);
    document.getElementById(`qty-${i}`).innerText = cart[i];

    let total = 0;
    Object.keys(cart).forEach(k => {
      total += cart[k] * products[k].price;
    });
    document.getElementById("total-price").innerText = total;
  }

  function showPayment() {
    document.getElementById("app-content").style.display = "none";
    document.getElementById("payment-ui").style.display = "block";
  }

  function confirmOrder() {
    const order = {
      uid: currentUserId,
      name: document.getElementById("cusName").value,
      address: document.getElementById("cusAddress").value,
      items: Object.keys(cart)
        .filter(i => cart[i] > 0)
        .map(i => `${products[i].desc} x${cart[i]}`)
        .join(", "),
      total: document.getElementById("total-price").innerText
    };

  fetch(GAS_API, {
    method: "POST",
    body: JSON.stringify(order)
  })
  .then(() => {
    liff.sendMessages([
      { type: "text", text: "‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" }
    ]).finally(() => liff.closeWindow());
  });


  window.onload = init;
</script>

</body>
</html>
