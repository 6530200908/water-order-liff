<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #1a1d21; color: white; padding: 15px; padding-bottom: 100px; font-family: sans-serif; }
    /* UI ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö Modal */
    #payment-ui { 
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 1000; padding: 20px; overflow-y: auto;
    }
    .modal-card { background: white; color: #333; border-radius: 20px; padding: 25px; margin-top: 30px; }
    .product-card { background: #2c3036; border: 1px solid #3e444d; border-radius: 12px; padding: 12px; margin-bottom: 10px; }
    /* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢‡∏ï‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠ */
    .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1d21; padding: 15px; border-top: 1px solid #333; z-index: 900; }
  </style>
</head>
<body>

  <div id="app-content">
    <h5 class="mb-4 text-center text-info">üõí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°</h5>
    <div id="product-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <div class="sticky-footer shadow-lg">
    <div class="d-flex justify-content-between mb-2 fs-5 px-2">
      <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span> <span id="total-price" class="fw-bold text-info">0</span> ‡∏ø
    </div>
    <button id="btn-next" class="btn btn-primary w-100 p-3 fw-bold" disabled>‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LINE...</button>
  </div>

  <div id="payment-ui">
    <div class="modal-card">
      <h5 class="text-center mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h5>
      <label class="small fw-bold text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
      <input type="text" id="cusName" class="form-control mb-3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠">
      
      <label class="small fw-bold text-muted">‡∏´‡∏≠‡∏û‡∏±‡∏Å/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
      <select id="locSelect" class="form-select mb-3" onchange="toggleOther(this.value)">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>
      </select>
      
      <label class="small fw-bold text-muted">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á</label>
      <textarea id="cusAddress" class="form-control mb-4" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á"></textarea>
      
      <button id="btn-confirm" class="btn btn-success w-100 p-3 fw-bold mb-2" onclick="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
      <button class="btn btn-light w-100" onclick="closePayment()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
  </div>

<script>
const GAS_API = "https://script.google.com/macros/s/AKfycbzDaovxh_RDbg8PGxccbWHEbbcOUYeekAETwAeuSMkPgU7E1TKHPNb7syactKQ2BvBMGQ/exec";
let products = [], cart = {}, currentUserId = "";

async function init() {
  await liff.init({ liffId: "2008859930-NxfsF3xM" });
  if (!liff.isLoggedIn()) { liff.login(); return; }
  
  const profile = await liff.getProfile();
  currentUserId = profile.userId;

  // --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ---
  // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏≠‡∏õ‡∏à‡∏∞‡∏î‡∏π‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô
  fetch(`${GAS_API}?type=products`) 
    .then(res => res.json())
    .then(data => {
      products = data;
      renderProducts(); // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      document.getElementById("btn-next").disabled = false;
      document.getElementById("btn-next").innerText = "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô";
    });

  // --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (Background) ---
  fetch(`${GAS_API}?type=init&uid=${currentUserId}`)
    .then(res => res.json())
    .then(res => {
      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏™‡πà Dropdown ‡πÅ‡∏•‡∏∞ Input ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
      const select = document.getElementById("locSelect");
      res.locations.forEach(loc => {
        if(![...select.options].some(o => o.value === loc)) {
           select.innerHTML += `<option value="${loc}">${loc}</option>`;
        }
      });
      if (![...select.options].some(o => o.value === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ")) {
         select.innerHTML += `<option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>`;
      }
      
      if (res.customer) {
        document.getElementById("cusName").value = res.customer.name;
        if (res.locations.includes(res.customer.address)) {
          select.value = res.customer.address;
        } else {
          select.value = "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";
          document.getElementById("cusAddress").value = res.customer.address;
        }
      }
    });
}

function renderProducts() {
  document.getElementById("product-list").innerHTML = products.map((p, i) => `
    <div class="product-card d-flex justify-content-between align-items-center shadow-sm">
      <div><b>${p.desc}</b><br><small class="text-info">${p.price} ‡∏ø</small></div>
      <div class="d-flex align-items-center gap-3">
        <button class="btn btn-sm btn-outline-light" onclick="updateQty(${i},-1)">-</button>
        <span id="qty-${i}" class="fw-bold fs-5">0</span>
        <button class="btn btn-sm btn-outline-light" onclick="updateQty(${i},1)">+</button>
      </div>
    </div>`).join("");
}

function updateQty(i, d) {
  cart[i] = Math.max(0, (cart[i] || 0) + d);
  document.getElementById(`qty-${i}`).innerText = cart[i];
  let total = 0;
  Object.keys(cart).forEach(k => total += cart[k] * products[k].price);
  document.getElementById("total-price").innerText = total;
}

function toggleOther(val) {
  if(val === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ") document.getElementById("cusAddress").focus();
}

document.getElementById("btn-next").onclick = () => {
  if(document.getElementById("total-price").innerText == "0") return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
  document.getElementById("payment-ui").style.display = "block";
};

function closePayment() {
  document.getElementById("payment-ui").style.display = "none";
}

function confirmOrder() {
  const loc = document.getElementById("locSelect").value;
  const addr = document.getElementById("cusAddress").value;
  if(!loc) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà");

  const btn = document.getElementById("btn-confirm");
  btn.disabled = true;
  btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

  const itemsInCart = Object.keys(cart).filter(i => cart[i] > 0);
  const order = {
    uid: currentUserId,
    name: document.getElementById("cusName").value,
    address: loc === "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" ? addr : loc + " " + addr,
    items: itemsInCart.map(i => products[i].desc).join(", "),
    amounts: itemsInCart.map(i => cart[i]).join(", "),
    total: document.getElementById("total-price").innerText
  };

  fetch(GAS_API, { method: "POST", mode: "no-cors", body: JSON.stringify(order) })
  .then(() => {
    liff.sendMessages([{ type: "text", text: `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${order.items}\n‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${order.total} ‡∏ø\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå` }])
    .finally(() => liff.closeWindow());
  });
}

window.onload = init;
</script>
</body>
</html>
