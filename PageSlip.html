<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="Styles.css">
</head>
<body>
  <div id="loader" class="text-center mt-5">
    <div class="spinner-border text-info"></div>
  </div>

  <div class="container mt-5" style="display:none;" id="mainContent">
    <div class="order-card text-center p-4 bg-dark rounded-4 shadow-sm">
      <h4 class="fw-bold mb-3">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</h4>
      <p id="slip-order-text" class="text-info bg-black p-2 rounded small"></p>

      <input type="file" accept="image/*" id="slipInput" class="form-control mb-3">
      <img id="preview" class="img-fluid rounded mb-3 mx-auto"
           style="display:none; border: 2px dashed #0dcaf0; max-height:300px;">

      <button class="btn btn-success w-100 p-3 fw-bold"
              id="sendBtn"
              disabled
              onclick="uploadSlip()">
        ‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
      </button>
    </div>
  </div>

  <script src="Config.js"></script>

  <script>
    let imageBase64 = "";
    let orderIdFromUrl = "";

    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      orderIdFromUrl = urlParams.get('order_id');

      try {
        await liff.init({ liffId: CONFIG.LIFF_ID_SLIP });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        if (!orderIdFromUrl) {
          alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå");
          return;
        }

        document.getElementById("slip-order-text").innerText =
          "‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: " + orderIdFromUrl;

        document.getElementById("slipInput").addEventListener("change", handleFile);

      } catch (err) {
        console.error("LIFF init error:", err);
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ");
      } finally {
        document.getElementById("loader").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
      }
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        alert("‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        imageBase64 = reader.result;

        const img = document.getElementById("preview");
        img.src = imageBase64;
        img.style.display = "block";

        document.getElementById("sendBtn").disabled = false;
      };
      reader.readAsDataURL(file);
    }

    async function uploadSlip() {
      const btn = document.getElementById("sendBtn");

      if (!imageBase64) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô");
        return;
      }

      btn.disabled = true;
      btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

      const payload = {
        order_id: orderIdFromUrl,
        slip_image: imageBase64
      };

      try {
        const res = await fetch(CONFIG.WEBHOOK_SLIP, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error("Upload failed");
        }

        await liff.sendMessages([
          { type: "text", text: "‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß" }
        ]);

        liff.closeWindow();

      } catch (err) {
        console.error(err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        btn.disabled = false;
        btn.innerText = "‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô";
      }
    }

    window.onload = init;
  </script>
</body>
</html>
