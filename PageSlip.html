<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕кр╕ер╕┤р╕Ы</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="Styles.css">
</head>
<body>
  <div id="loader"><div class="spinner-border text-info"></div></div>
  <div class="container mt-5">
    <div class="order-card text-center p-4 bg-dark rounded-4 shadow-sm">
      <h4 class="fw-bold mb-3">ЁЯУд р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕кр╕ер╕┤р╕Ы</h4>
      <p id="slip-order-text" class="text-info bg-black p-2 rounded small"></p>
      <input type="file" accept="image/*" id="slipInput" class="form-control mb-3">
      <img id="preview" class="img-fluid rounded mb-3 mx-auto" style="display:none; border: 2px dashed #0dcaf0;">
      <button class="btn btn-success w-100 p-3 fw-bold" id="sendBtn" disabled onclick="uploadSlip()">р╕кр╣Ир╕Зр╕кр╕ер╕┤р╕Ыр╣Вр╕нр╕Щр╣Ар╕Зр╕┤р╕Щ</button>
    </div>
  </div>

  <script src="Config.js"></script>
  <script>
    let imageBase64 = "", orderIdFromUrl = "";
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      orderIdFromUrl = urlParams.get('order_id');
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID_SLIP });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        if(orderIdFromUrl) document.getElementById("slip-order-text").innerText = "р╕нр╕нр╣Ар╕Фр╕нр╕гр╣М: " + orderIdFromUrl;

        document.getElementById("slipInput").onchange = e => {
          const reader = new FileReader();
          reader.onload = () => {
            imageBase64 = reader.result;
            const img = document.getElementById("preview");
            img.src = imageBase64; img.style.display = "block";
            document.getElementById("sendBtn").disabled = false;
          };
          reader.readAsDataURL(e.target.files[0]);
        };
      } catch (e) { console.error(e); }
      finally { document.getElementById("loader").style.display = "none"; }
    }
    async function uploadSlip() {
      document.getElementById("sendBtn").disabled = true;
      try {
        await fetch(CONFIG.WEBHOOK_SLIP, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ order_id: orderIdFromUrl, slip_image: imageBase64 })
        });
        liff.sendMessages([{ type: "text", text: "тЬЕ р╕кр╣Ир╕Зр╕кр╕ер╕┤р╕Ыр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з" }]).finally(() => liff.closeWindow());
      } catch (err) { alert("р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф"); document.getElementById("sendBtn").disabled = false; }
    }
    window.onload = init;
  </script>
</body>
</html>
