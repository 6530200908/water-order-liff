<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>จัดการระบบสินค้า</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="Styles.css">
  <style>
    .admin-card { background: #1a1d20; border-radius: 15px; border: 1px solid #343a40; margin-bottom: 15px; padding: 15px; position: relative; }
    .btn-delete { position: absolute; top: 10px; right: 10px; color: #dc3545; cursor: pointer; border: none; background: none; font-size: 1.2rem; }
    .input-group-text { background: #2b3035; color: #0dcaf0; border: 1px solid #343a40; }
    .form-control { background: #212529; color: white; border: 1px solid #343a40; }
    .form-control:focus { background: #2b3035; color: white; border-color: #0dcaf0; box-shadow: none; }
    .add-card { border: 2px dashed #343a40; background: transparent; cursor: pointer; transition: 0.3s; }
    .add-card:hover { border-color: #0dcaf0; background: rgba(13, 202, 240, 0.05); }
  </style>
</head>
<body class="bg-black text-white">
  <div id="loader" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000;">
    <div class="spinner-border text-info"></div>
  </div>

  <div class="container mt-4" style="padding-bottom: 100px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="fw-bold m-0 text-info">⚙️ จัดการระบบสินค้า</h4>
      <button onclick="saveAllToSheet()" id="btn-save-all" class="btn btn-success fw-bold px-4">บันทึกทั้งหมด</button>
    </div>

    <div id="admin-product-list">
      </div>

    <div class="admin-card add-card text-center p-4" onclick="addNewProduct()">
      <div class="text-info fs-1">+</div>
      <div class="text-muted">เพิ่มสินค้าใหม่</div>
    </div>
  </div>

  <script src="Config.js"></script>
  <script>
    let products = [];

    async function init() {
      try {
        const res = await fetch(`${CONFIG.GAS_API}?type=admin_get_products`).then(r => r.json());
        products = res.products || [];
        renderAdminProducts();
      } catch (e) {
        console.error(e);
        alert("โหลดข้อมูลไม่สำเร็จ");
      } finally {
        document.getElementById("loader").style.display = "none";
      }
    }

    function renderAdminProducts() {
      const list = document.getElementById("admin-product-list");
      list.innerHTML = products.map((p, i) => `
        <div class="admin-card">
          <button class="btn-delete" onclick="removeProduct(${i})">&times;</button>
          <div class="row g-2">
            <div class="col-12 mb-2">
              <label class="small text-muted">ชื่อสินค้า/รายละเอียด</label>
              <input type="text" class="form-control fw-bold text-info" value="${p.desc}" 
                onchange="updateLocalData(${i}, 'desc', this.value)" placeholder="เช่น น้ำสิงห์ 600ml">
            </div>
            <div class="col-6">
              <label class="small text-muted">ราคา (฿)</label>
              <input type="number" class="form-control" value="${p.price}" 
                onchange="updateLocalData(${i}, 'price', this.value)">
            </div>
            <div class="col-6">
              <label class="small text-muted">สต็อก (ขวด)</label>
              <input type="number" class="form-control" value="${p.stock}" 
                onchange="updateLocalData(${i}, 'stock', this.value)">
            </div>
          </div>
        </div>
      `).join("");
    }

    function updateLocalData(index, field, value) {
      products[index][field] = (field === 'desc') ? value : Number(value);
    }

    function addNewProduct() {
      // สร้าง ID ใหม่แบบง่ายๆ (สุ่ม) หรือใช้ลำดับ
      const newId = "P-" + Math.floor(1000 + Math.random() * 9000);
      products.push({ id: newId, desc: "", price: 0, stock: 0 });
      renderAdminProducts();
      window.scrollTo(0, document.body.scrollHeight);
    }

    function removeProduct(index) {
      if(confirm("ยืนยันการลบสินค้านี้?")) {
        products.splice(index, 1);
        renderAdminProducts();
      }
    }

    async function saveAllToSheet() {
      const btn = document.getElementById("btn-save-all");
      btn.disabled = true;
      btn.innerText = "กำลังเซฟ...";
      
      try {
        const response = await fetch(CONFIG.GAS_API, {
          method: "POST",
          body: JSON.stringify({
            type: "admin_sync_all_products", // ใช้โหมด Sync ทั้งหมด
            data: products
          })
        });
        const result = await response.json();
        if(result.status === "success") {
          alert("อัปเดตข้อมูลสินค้าทั้งหมดเรียบร้อยแล้ว!");
        }
      } catch (e) {
        alert("เกิดข้อผิดพลาดในการบันทึก");
      } finally {
        btn.disabled = false;
        btn.innerText = "บันทึกทั้งหมด";
      }
    }

    window.onload = init;
  </script>
</body>
</html>
